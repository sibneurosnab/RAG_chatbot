# 5. Late Chunking & –°—Ç—Ä–∞—Ç–µ–≥–∏–∏ –ß–∞–Ω–∫–∏—Ä–æ–≤–∞–Ω–∏—è

> –≠—Ç–æ—Ç –¥–æ–∫—É–º–µ–Ω—Ç –æ–±—ä–µ–¥–∏–Ω—è–µ—Ç –º–∞—Ç–µ—Ä–∏–∞–ª—ã –∏–∑ `chunking_strategy.md` –∏ `latechunkin_strategy.md` –∏ –¥–µ–π—Å—Ç–≤—É–µ—Ç –∫–∞–∫ **–µ–¥–∏–Ω—Å—Ç–≤–µ–Ω–Ω—ã–π –∏—Å—Ç–æ—á–Ω–∏–∫ –ø—Ä–∞–≤–¥—ã** –ø–æ –Ω–∞—Å—Ç—Ä–æ–π–∫–µ –∏ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—é Late Chunking –≤ –ø—Ä–æ–µ–∫—Ç–µ.
>
> –û–Ω –æ–ø–∏—Å—ã–≤–∞–µ—Ç:
> ‚Ä¢ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã —ç–Ω–¥-–ø–æ–∏–Ω—Ç–∞ `/embed_late_chunk`;  
> ‚Ä¢ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ–º—ã–µ —Å—Ç—Ä–∞—Ç–µ–≥–∏–∏ —á–∞–Ω–∫–∏—Ä–æ–≤–∞–Ω–∏—è;  
> ‚Ä¢ –≤—ã–±–æ—Ä –æ–ø—Ç–∏–º–∞–ª—å–Ω–æ–π —Å—Ç—Ä–∞—Ç–µ–≥–∏–∏ –ø–æ–¥ —Ç–∏–ø –∫–æ–Ω—Ç–µ–Ω—Ç–∞;  
> ‚Ä¢ –ø–∞—Ä–∞–º–µ—Ç—Ä `task` (`retrieval.passage` vs `retrieval.query`);  
> ‚Ä¢ —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ –∏ —Ä–∞–±–æ—á–∏–µ –ø—Ä–∏–º–µ—Ä—ã.

---

## 5.1 –ß—Ç–æ —Ç–∞–∫–æ–µ Late Chunking

Late Chunking ‚Äî —ç—Ç–æ ¬´–æ—Ç–ª–æ–∂–µ–Ω–Ω–æ–µ¬ª —Ä–∞–∑–±–∏–µ–Ω–∏–µ —Ç–µ–∫—Å—Ç–∞ –Ω–∞ —á–∞–Ω–∫–∏ **–ø–æ—Å–ª–µ** –ø–æ–ª–Ω–æ–≥–æ –ø—Ä–æ—Ö–æ–¥–∞ —Ç—Ä–∞–Ω—Å—Ñ–æ—Ä–º–µ—Ä–∞, –∞ –Ω–µ –¥–æ –Ω–µ–≥–æ, –∫–∞–∫ –≤ –∫–ª–∞—Å—Å–∏—á–µ—Å–∫–æ–º –ø–∞–π–ø–ª–∞–π–Ω–µ. –ê–ª–≥–æ—Ä–∏—Ç–º:

1. –¢–µ–∫—Å—Ç —Ü–µ–ª–∏–∫–æ–º —Ç–æ–∫–µ–Ω–∏–∑–∏—Ä—É–µ—Ç—Å—è –∏ –ø—Ä–æ–ø—É—Å–∫–∞–µ—Ç—Å—è —á–µ—Ä–µ–∑ –º–æ–¥–µ–ª—å ‚Üí –ø–æ–ª—É—á–∞–µ–º —Ç–æ–∫–µ–Ω-—ç–º–±–µ–¥–¥–∏–Ω–≥–∏ c –ø–æ–ª–Ω—ã–º –∫–æ–Ω—Ç–µ–∫—Å—Ç–æ–º.
2. –î–∞–ª–µ–µ —Ç–µ–∫—Å—Ç **–æ–¥–∏–Ω —Ä–∞–∑** —Ä–∞–∑–±–∏–≤–∞–µ—Ç—Å—è –Ω–∞ —á–∞–Ω–∫–∏ –ø–æ –≤—ã–±—Ä–∞–Ω–Ω–æ–π —Å—Ç—Ä–∞—Ç–µ–≥–∏–∏ (—Å–º. 5.3).  
3. –î–ª—è –∫–∞–∂–¥–æ–≥–æ —á–∞–Ω–∫–∞ –≤—ã–ø–æ–ª–Ω—è–µ—Ç—Å—è *mean-pooling* —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É—é—â–∏—Ö —Ç–æ–∫–µ–Ω-–≤–µ–∫—Ç–æ—Ä–æ–≤.  
4. –ò—Ç–æ–≥–æ–≤—ã–µ —ç–º–±–µ–¥–¥–∏–Ω–≥–∏ –Ω–æ—Ä–º–∞–ª–∏–∑—É—é—Ç—Å—è (L2) –∏ –≤–æ–∑–≤—Ä–∞—â–∞—é—Ç—Å—è –∫–ª–∏–µ–Ω—Ç—É.

–ü—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞:
‚Ä¢ –∫–æ–Ω—Ç–µ–∫—Å—Ç —Å–æ—Å–µ–¥–Ω–∏—Ö —á–∞–Ω–∫–æ–≤ —É—á–∏—Ç—ã–≤–∞–µ—Ç—Å—è –≤–Ω—É—Ç—Ä–∏ —ç–º–±–µ–¥–¥–∏–Ω–≥–æ–≤;  
‚Ä¢ –Ω–µ—Ç —Ä–∏—Å–∫–∞ ¬´–ø–æ—Ä–≤–∞—Ç—å¬ª —Å—É—â–Ω–æ—Å—Ç–∏ –ø—Ä–∏ –∂—ë—Å—Ç–∫–æ–º split;  
‚Ä¢ —ç–∫–æ–Ω–æ–º–∏—è –≤—Ä–µ–º–µ–Ω–∏ ‚Äî –æ–¥–∏–Ω –ø—Ä–æ–≥–æ–Ω –º–æ–¥–µ–ª–∏ –≤–º–µ—Å—Ç–æ N.

---

## 5.2 –ü–∞—Ä–∞–º–µ—Ç—Ä—ã —ç–Ω–¥-–ø–æ–∏–Ω—Ç–∞ `/embed_late_chunk`

| –ü–∞—Ä–∞–º–µ—Ç—Ä      | –¢–∏–ø      | –ü–æ —É–º–æ–ª—á–∞–Ω–∏—é          | –û–ø–∏—Å–∞–Ω–∏–µ |
|---------------|----------|-----------------------|----------|
| `texts`       | list[str] | **–æ–±—è–∑–∞—Ç–µ–ª–µ–Ω**        | –ú–∞—Å—Å–∏–≤, –≥–¥–µ **–∫–∞–∂–¥—ã–π —ç–ª–µ–º–µ–Ω—Ç ‚Äî –ø–æ–ª–Ω–æ—Ü–µ–Ω–Ω—ã–π –¥–æ–∫—É–º–µ–Ω—Ç —Ü–µ–ª–∏–∫–æ–º**. –ï—Å–ª–∏ –∏–Ω–¥–µ–∫—Å–∏—Ä—É–µ—Ç–µ –æ–¥–∏–Ω –¥–æ–∫—É–º–µ–Ω—Ç, –ø–µ—Ä–µ–¥–∞–π—Ç–µ —Å–ø–∏—Å–æ–∫ –∏–∑ –æ–¥–Ω–æ–π —Å—Ç—Ä–æ–∫–∏. |
| `strategy`    | str      | `paragraph`           | C—Ç—Ä–∞—Ç–µ–≥–∏—è —Ä–∞–∑–±–∏–µ–Ω–∏—è: `paragraph`, `sentence`, `fixed`. |
| `chunk_size`  | int      | ‚Äî                     | –†–∞–∑–º–µ—Ä —á–∞–Ω–∫–∞ (—Ç–æ–ª—å–∫–æ –¥–ª—è `fixed`). |
| `overlap`     | int      | `0`                   | –ü–µ—Ä–µ–∫—Ä—ã—Ç–∏–µ —á–∞–Ω–∫–æ–≤ (—Ç–æ–ª—å–∫–æ –¥–ª—è `fixed`). |
| `task`        | str      | `retrieval.passage`   | –ö–∞–∫–æ–π adapter –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å: `retrieval.passage` (–¥–æ–∫–∏) –∏–ª–∏ `retrieval.query` (–∑–∞–ø—Ä–æ—Å—ã). |

> –ú–æ–¥–µ–ª—å `jina-embeddings-v3` –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç *adapter_mask* ‚Üí –º–æ–∂–Ω–æ –º–µ–Ω—è—Ç—å –ø–æ–≤–µ–¥–µ–Ω–∏–µ –±–µ–∑ –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∫–∏.
> **–í–∞–∂–Ω–æ ‚ö†Ô∏è** –ù–µ –ø–µ—Ä–µ–¥–∞–≤–∞–π—Ç–µ –æ–¥–∏–Ω –∏ —Ç–æ—Ç –∂–µ –¥–æ–∫—É–º–µ–Ω—Ç —Ä–∞–∑–±–∏—Ç—ã–º –Ω–∞ –º–Ω–æ–∂–µ—Å—Ç–≤–æ —Å—Ç—Ä–æ–∫ –≤ `texts`. –°–µ—Ä–≤–∏—Å –≤–æ—Å–ø—Ä–∏–º–µ—Ç –∫–∞–∂–¥—É—é —Å—Ç—Ä–æ–∫—É –∫–∞–∫ –æ—Ç–¥–µ–ª—å–Ω—ã–π –¥–æ–∫—É–º–µ–Ω—Ç, –≤—ã–ø–æ–ª–Ω–∏—Ç –∏–Ω—Ñ–µ—Ä–µ–Ω—Å –Ω–µ—Å–∫–æ–ª—å–∫–æ —Ä–∞–∑ –∏ –ø–æ—Ç–µ—Ä—è–µ—Ç –≥–ª–æ–±–∞–ª—å–Ω—ã–π –∫–æ–Ω—Ç–µ–∫—Å—Ç. Late Chunking –ø–æ–ª–∞–≥–∞–µ—Ç—Å—è –Ω–∞ —Ç–æ, —á—Ç–æ *–≤–µ—Å—å* —Ç–µ–∫—Å—Ç –ø—Ä–∏—Ö–æ–¥–∏—Ç –µ–¥–∏–Ω—ã–º –∫—É—Å–∫–æ–º, –∞ –≤–Ω—É—Ç—Ä–µ–Ω–Ω–∏–π —Ä–∞–∑—Ä–µ–∑ –≤—ã–ø–æ–ª–Ω—è–µ—Ç—Å—è —Å–µ—Ä–≤–µ—Ä–æ–º —Å–æ–≥–ª–∞—Å–Ω–æ –≤—ã–±—Ä–∞–Ω–Ω–æ–π —Å—Ç—Ä–∞—Ç–µ–≥–∏–∏.

---

## 5.3 –ü–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ–º—ã–µ —Å—Ç—Ä–∞—Ç–µ–≥–∏–∏

### 5.3.1 `paragraph`
–†–∞–∑–±–∏–≤–∞–µ—Ç –ø–æ –¥–≤–æ–π–Ω–æ–º—É `\n\n`. –°–æ—Ö—Ä–∞–Ω—è–µ—Ç –ª–æ–≥–∏—á–µ—Å–∫–∏–µ –∞–±–∑–∞—Ü—ã.

**–ü–ª—é—Å—ã:** –µ—Å—Ç–µ—Å—Ç–≤–µ–Ω–Ω—ã–µ –≥—Ä–∞–Ω–∏—Ü—ã, –º–∞–ª–æ –æ–±—Ä—ã–≤–æ–≤ –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞.  
**–ú–∏–Ω—É—Å—ã:** –∑–∞–≤–∏—Å–∏—Ç –æ—Ç —Ä–∞–∑–º–µ—Ç–∫–∏, –º–æ–∂–µ—Ç –¥–∞–≤–∞—Ç—å –Ω–µ—Ä–∞–≤–Ω–æ–º–µ—Ä–Ω—ã–µ —á–∞–Ω–∫–∏.

### 5.3.2 `sentence`
Split –ø–æ –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è–º (regex `(?<=[.!?])\s+`).

**–ü–ª—é—Å—ã:** —Ç–æ—á–Ω–æ–µ —Å–µ–º–∞–Ω—Ç–∏—á–µ—Å–∫–æ–µ —Ä–∞–∑–¥–µ–ª–µ–Ω–∏–µ, –∏–¥–µ–∞–ª—å–Ω–æ –¥–ª—è —Ç—Ä–∞–Ω—Å–∫—Ä–∏–ø—Ü–∏–π/–¥–∏–∞–ª–æ–≥–æ–≤.  
**–ú–∏–Ω—É—Å—ã:** –º–Ω–æ–≥–æ –º–µ–ª–∫–∏—Ö —á–∞–Ω–∫–æ–≤ ‚Üí —É–≤–µ–ª–∏—á–∏–≤–∞–µ—Ç –∏–Ω–¥–µ–∫—Å.

### 5.3.3 `fixed`
–†–∞–∑–º–µ—Ä –≤ —Ç–æ–∫–µ–Ω–∞—Ö + –ø–µ—Ä–µ–∫—Ä—ã—Ç–∏–µ.

```json
{
  "strategy": "fixed",
  "chunk_size": 384,
  "overlap": 32
}
```

**–ü–ª—é—Å—ã:** —Ä–æ–≤–Ω—ã–µ —á–∞–Ω–∫–∏, –ø–æ–ª–Ω—ã–π –∫–æ–Ω—Ç—Ä–æ–ª—å.  
**–ú–∏–Ω—É—Å—ã:** –º–æ–∂–µ—Ç —Ä–µ–∑–∞—Ç—å —Ñ—Ä–∞–∑—ã, —Ç—Ä–µ–±—É–µ—Ç —Ç—é–Ω–∏–Ω–≥–∞.

---

## 5.4 –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ –ø–æ –≤—ã–±–æ—Ä—É —Å—Ç—Ä–∞—Ç–µ–≥–∏–∏

| –¢–∏–ø –∫–æ–Ω—Ç–µ–Ω—Ç–∞                | –°—Ç—Ä–∞—Ç–µ–≥–∏—è     | –ü–∞—Ä–∞–º–µ—Ç—Ä—ã                       |
|-----------------------------|---------------|---------------------------------|
| –°—Ç–∞—Ç—å–∏, –∫–Ω–∏–≥–∏, DOC/PDF      | `paragraph`   | ‚Äî                               |
| –¢—Ä–∞–Ω—Å–∫—Ä–∏–ø—Ü–∏–∏ –≤–∏–¥–µ–æ, –ø–æ–¥–∫–∞—Å—Ç | `sentence`    | ‚Äî                               |
| –ù–µ—Å—Ç—Ä—É–∫—Ç—É—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã–π —Ç–µ–∫—Å—Ç   | `fixed`       | `chunk_size 384 / overlap 32`   |
| –û—á–µ–Ω—å –¥–ª–∏–Ω–Ω—ã–µ –¥–æ–∫—É–º–µ–Ω—Ç—ã     | `fixed`       | `chunk_size 512 / overlap 64`   |

---

## 5.5 –ü–∞—Ä–∞–º–µ—Ç—Ä `task`

| –°—Ü–µ–Ω–∞—Ä–∏–π           | `task`               | –≠–Ω–¥-–ø–æ–∏–Ω—Ç                                   |
|--------------------|----------------------|---------------------------------------------|
| –ò–Ω–¥–µ–∫—Å–∞—Ü–∏—è –¥–æ–∫–æ–≤   | `retrieval.passage`  | `/embed_late_chunk?task=retrieval.passage`  |
| –ü–æ–∏—Å–∫–æ–≤—ã–µ –∑–∞–ø—Ä–æ—Å—ã  | `retrieval.query`    | `/embed_late_chunk?task=retrieval.query`               |

–ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ–≥–æ `task` **–∫—Ä–∏—Ç–∏—á–Ω–æ**: –¥–æ–∫—É–º–µ–Ω—Ç—ã –∏ –∑–∞–ø—Ä–æ—Å—ã –∫–æ–¥–∏—Ä—É—é—Ç—Å—è —Ä–∞–∑–Ω—ã–º–∏ –≥–æ–ª–æ–≤–∞–º–∏, —á—Ç–æ —É–ª—É—á—à–∞–µ—Ç recall/precision.

---

## 5.6 –ü—Ä–∞–∫—Ç–∏—á–µ—Å–∫–∏–µ –ø—Ä–∏–º–µ—Ä—ã

### 5.6.1 –ê–±–∑–∞—Ü—ã (DOC/PDF)
```bash
curl -X POST "http://jina-embed-gpu:8008/embed_late_chunk?task=retrieval.passage" \
     -H "Content-Type: application/json" \
     -d '{
       "texts": ["üìÑ –ë–æ–ª—å—à–æ–π —Ç–µ–∫—Å—Ç —Å—Ç–∞—Ç—å–∏ ..."],
       "strategy": "paragraph"
     }'
```

### 5.6.2 –¢—Ä–∞–Ω—Å–∫—Ä–∏–ø—Ü–∏—è –≤–∏–¥–µ–æ
```bash
curl -X POST "http://jina-embed-gpu:8008/embed_late_chunk?task=retrieval.passage" \
     -H "Content-Type: application/json" \
     -d '{
       "texts": ["üîä –†–∞—Å—à–∏—Ñ—Ä–æ–≤–∫–∞ ..."],
       "strategy": "sentence"
     }'
```

### 5.6.3 –ù–µ—Å—Ç—Ä—É–∫—Ç—É—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã–π —Ç–µ–∫—Å—Ç
```bash
curl -X POST "http://jina-embed-gpu:8008/embed_late_chunk?task=retrieval.passage" \
     -H "Content-Type: application/json" \
     -d '{
       "texts": ["‚öôÔ∏è –õ–æ–≥–∏ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è ..."],
       "strategy": "fixed",
       "chunk_size": 384,
       "overlap": 32
     }'
```

---

## 5.7 –¢–µ—Ö–Ω–∏—á–µ—Å–∫–∏–µ –¥–µ—Ç–∞–ª–∏ —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏

1. **Tokenize-once:** —Ç–µ–∫—Å—Ç –ø—Ä–æ—Ö–æ–¥–∏—Ç –º–æ–¥–µ–ª—å –ø–æ–ª–Ω–æ—Å—Ç—å—é ‚Üí –æ–¥–Ω–∞ –∏–Ω—Ñ–µ—Ä–µ–Ω—Å-–∏—Ç–µ—Ä–∞—Ü–∏—è.  
2. **Pooling:** –¥–ª—è –∫–∞–∂–¥–æ–≥–æ —á–∞–Ω–∫–∞ –±–µ—Ä—ë—Ç—Å—è mean-pooling –µ–≥–æ —Ç–æ–∫–µ–Ω–æ–≤, –º–∞—Å–∫–∞ –≤–Ω–∏–º–∞–Ω–∏—è –≥–∞—Ä–∞–Ω—Ç–∏—Ä—É–µ—Ç –æ—Ç—Å—É—Ç—Å—Ç–≤–∏–µ —Å–ø–µ—Ü-—Ç–æ–∫–µ–Ω–æ–≤.  
3. **L2-–Ω–æ—Ä–º–∞:** –≤—Å–µ –≤–µ–∫—Ç–æ—Ä—ã –Ω–æ—Ä–º–∞–ª–∏–∑—É—é—Ç—Å—è ‚Üí –∫–æ—Å–∏–Ω—É—Å–Ω–æ–µ —Å—Ö–æ–¥—Å—Ç–≤–æ = —Å–∫–∞–ª—è—Ä–Ω–æ–µ –ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏–µ.
4. **Adapter mask:** –µ—Å–ª–∏ `task_supported=True`, –≤ –≤—ã–∑–æ–≤–µ –¥–æ–±–∞–≤–ª—è–µ—Ç—Å—è `adapter_mask` —Å ID –Ω—É–∂–Ω–æ–≥–æ –∞–¥–∞–ø—Ç–µ—Ä–∞.

---
–°–ª–µ–¥—É—é—â–∏–π –¥–æ–∫—É–º–µ–Ω—Ç: **06_database.md** ‚Äì —Å—Ç—Ä—É–∫—Ç—É—Ä–∞ –ë–î –∏ –≤–µ–∫—Ç–æ—Ä–Ω—ã–µ –∏–Ω–¥–µ–∫—Å—ã.